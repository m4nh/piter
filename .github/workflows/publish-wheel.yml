name: Publish wheel to Azure Artifacts

on:
  push:
    tags:
      - "v*"

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: self-hosted
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag commit is on main
        shell: bash
        run: |
          git fetch origin main --depth=1
          if git merge-base --is-ancestor "${GITHUB_SHA}" "origin/main"; then
            echo "OK: tag commit is contained in main"
          else
            echo "ERROR: this tag does not point to a commit on main" >&2
            exit 1
          fi

      - name: Build & publish
        uses: ./.github/actions/publish-wheel
        with:
          python-version: "3.12"
          artifacts-pypi-url: ${{ secrets.AZURE_ARTIFACTS_PYPI_URL }}
          artifacts-pat: ${{ secrets.AZURE_ARTIFACTS_PAT }}
