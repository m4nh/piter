version: 2.1 #reopen

orbs:
  slack: circleci/slack@4.9.3

jobs:
  compute_version:
    docker:
      - image: cimg/python:3.12.12
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -e .[tests]
      - run:
          name: Compute Package Version
          command: |
            if [ -z "${PACKAGE_NAME:-}" ]; then
              echo "PACKAGE_NAME is not set" >&2
              exit 1
            fi

            PKG_VER=$(python -c "import importlib.metadata as m; print(m.version('${PACKAGE_NAME}'))")
            echo "${PKG_VER}" > package_version.txt
      - persist_to_workspace:
          root: .
          paths:
            - package_version.txt
  
  test:
    docker:
      - image: cimg/python:3.12.12
    steps:
      - run:
          name: Check environment
          command: |
            if [ -z "${PACKAGE_NAME:-}" ]; then
              echo "PACKAGE_NAME is not set" >&2
              exit 1
            fi
      - checkout
      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -e .[tests]
      - run:
          name: Run pytests with coverage
          command: | 
            mkdir test-results
            pytest --cov=${PACKAGE_NAME} --cov-fail-under=80 --junitxml=test-results/junit.xml
  build_and_push:
    docker:
      - image: cimg/python:3.12.12
    steps:
      - checkout
      - run:
          name: Install 
          command: |
            python -m pip install --upgrade pip
            pip install -e .
      - run:
          name: Read Package Version
          command: |
            export VERSION=$(cat package_version.txt)
            echo "IMAGE_TAG=${VERSION}" >> $BASH_ENV
      - setup_remote_docker
      - run:
          name: Build and Push Docker image
          command: |
            source $BASH_ENV

            if [ -z "${DOCKERHUB_USERNAME:-}" ] || [ -z "${DOCKERHUB_PASSWORD:-}" ] || [ -z "${DOCKER_PREFIX:-}" ]; then
              echo "Docker Hub credentials are not set" >&2
              exit 1
            fi

            IMAGE="${DOCKER_PREFIX}/${PACKAGE_NAME}:${IMAGE_TAG}"

            echo "Logging into Docker Hub as ${DOCKERHUB_USERNAME}"
            echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

            echo "Building image ${IMAGE}"
            docker build -t "${IMAGE}" .

            echo "Pushing ${IMAGE}"
            docker push "${IMAGE}"

            echo ${IMAGE} > docker_image.txt
      - persist_to_workspace:
          root: .
          paths:
            - docker_image.txt
  notify:
    docker:
      - image: cimg/base:current
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Read Package Version
          command: |
            export VERSION=$(cat package_version.txt)
            export DOCKER_IMAGE=$(cat docker_image.txt)
            echo "PACKAGE_VERSION=${VERSION}" >> $BASH_ENV
            echo "DOCKER_IMAGE=${DOCKER_IMAGE}" >> $BASH_ENV
      - slack/notify:
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":tag: ${PACKAGE_NAME} got a new version -> *${PACKAGE_VERSION}* \n :white_check_mark: all tests passed! \n New Docker Image: ${DOCKER_IMAGE}"
                  }
                }
              ]
            }
          event: always
      
workflows:
  send-notification:
    jobs:
      - compute_version:
          filters: 
            tags:
              only: /v.*/
      - test:
          filters:  
            tags:
              only: /v.*/
          requires:
            - compute_version
      - build_and_push:
          filters:  
            tags:
              only: /v.*/
          requires:
            - test
      - notify:
          context: slack-secrets
          filters:  
            tags:
              only: /v.*/
          requires:
            - build_and_push


# - test:
#     filters:  # required since `deploy` has tag filters AND requires `build`
#       tags:
#         only: /.*/
# - build_and_push:
#     # requires:
#     #   - test
#     filters: 
#       branches:
#         only: main
#       tags:
#         only: /^v.*/