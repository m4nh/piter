version: 2.1 #reopen

orbs:
  slack: circleci/slack@4.9.3

jobs:
  notify:
    docker:
      - image: cimg/base:current
    steps:
      - slack/notify:
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "New CI/CD Generic *message* :art: for ${PACKAGE_NAME}"
                  }
                }
              ]
            }
          event: always
  test:
    docker:
      - image: cimg/python:3.12.12
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -e .[tests]
      - run:
          name: Run pytests with coverage
          command: | 
            mkdir test-results
            pytest --cov=${PACKAGE_NAME} --cov-fail-under=80 --junitxml=test-results/junit.xml
  build_and_push:
    docker:
      - image: cimg/python:3.12.12
    steps:
      - run:
          name: Check environment
          command: |
            if [ -z "${PACKAGE_NAME:-}" ]; then
              echo "PACKAGE_NAME is not set" >&2
              exit 1
            fi
      - checkout
      - run:
          name: Install 
          command: |
            python -m pip install --upgrade pip
            pip install -e .
      - run:
          name: Compute Version
          command: |
            PKG_VER=$(python -c "import importlib.metadata as m; print(m.version('${PACKAGE_NAME}'))")
            echo "export IMAGE_TAG=${PKG_VER}" >> $BASH_ENV
      - setup_remote_docker
      - run:
          name: Build and Push Docker image
          command: |
            source $BASH_ENV

            if [ -z "${DOCKERHUB_USERNAME:-}" ] || [ -z "${DOCKERHUB_PASSWORD:-}" ] || [ -z "${DOCKER_PREFIX:-}" ]; then
              echo "Docker Hub credentials are not set" >&2
              exit 1
            fi

            IMAGE="${DOCKER_PREFIX}/${PACKAGE_NAME}:${IMAGE_TAG}"

            echo "Logging into Docker Hub as ${DOCKERHUB_USERNAME}"
            echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

            echo "Building image ${IMAGE}"
            docker build -t "${IMAGE}" .

            echo "Pushing ${IMAGE}"
            docker push "${IMAGE}"

      
workflows:
  build-and-notify:
    jobs:
      - notify

# - test:
#     filters:  # required since `deploy` has tag filters AND requires `build`
#       tags:
#         only: /.*/
# - build_and_push:
#     # requires:
#     #   - test
#     filters: 
#       branches:
#         only: main
#       tags:
#         only: /^v.*/